/**
 * @package DJ-Reviews
 * @copyright Copyright (C) DJ-Extensions.com, All rights reserved.
 * @license http://www.gnu.org/licenses GNU/GPL
 * @author url: http://dj-extensions.com
 * @author email contact@dj-extensions.com
 *
 * DJ-Reviews is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * DJ-Reviews is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with DJ-Reviews. If not, see <http://www.gnu.org/licenses/>.
 *
 */

!function(d,c){var t=function(t){this.init(t)};t.prototype={constructor:t,init:function(t){var s=this;this.options=t,this.url=t.url,this.current_page=0,this.formId="djrv_review_form-"+this.options.item_id,this.formAnchorId="djrv-your-review-"+this.options.item_id,this.listId="djrv-reviews-list-"+this.options.item_id,this.ratingId="djrv-rating-full-"+this.options.item_id,this.ratingAvgId="djrv-rating-avg-"+this.options.item_id,this.addButtonClass="djrv_add_button",this.editButtonClass="djrv_edit_button",this.deleteButtonClass="djrv_delete_button",this.closeButtonClass="djrv_close_form_button",this.commentFormId="djrv_comment_form-"+this.options.item_id,this.commentAnchorId="djrv-your-comment-"+this.options.item_id,this.addCommentCls="djrv_comment_button",this.editCommentCls="djrv_comment_edit",this.closeCommentCls="djrv_close_comment_form",this.deleteCommentCls="djrv_comment_delete";var e=d('[data-toggle="djreviewsform"][data-objectid="'+this.options.item_id+'"]');if(0<e.length){if(e.unbind("click"),d("#"+this.formAnchorId).length<1){var i=d("<div />",{id:"djrv-your-review-"+this.options.item_id,class:"djrv_review_form djreviews djrv_clearfix",html:""});d(document.body).append(i),s.loadEditForm(0,!1,!1)}e.click(function(t){var e=d(this);t.preventDefault();var i="";if(e.attr("data-customparams")){var n=JSON.parse(e.attr("data-customparams")),o=[];for(var r in n)o.push("custom["+r+"]="+n[r]);i=o.join("&")}s.loadEditForm(0,!0,!1,i)})}this.attachControls(),this.refreshAll(!0,!1)},attachControls:function(){var r=this;if(this.reviewForm=d("#"+this.formId),this.formAnchor=d("#"+this.formAnchorId),this.reviewsList=d("#"+this.listId),this.rating=d("#"+this.ratingId),this.ratingAvg=d("#"+this.ratingAvgId),this.addReviewButtons=d.find("."+this.addButtonClass),this.editReviewButtons=d.find("."+this.editButtonClass),this.deleteReviewButtons=d.find("."+this.deleteButtonClass),this.closeReviewButtons=d.find("."+this.closeButtonClass),this.commentForm=d("#"+this.commentFormId),this.commentAnchor=d("#"+this.commentAnchorId),this.addCommentButtons=d("."+this.addCommentCls),this.editCommentButtons=d("."+this.editCommentCls),this.closeCommentButtons=d("."+this.closeCommentCls),this.deleteCommentButtons=d("."+this.deleteCommentCls),this.paginationLinks=d("#"+this.listId).find(".djrv_pagination a.pagenav"),0<this.paginationLinks.length&&d(this.paginationLinks).each(function(t,i){d(i).unbind("click"),d(i).click(function(t){t.preventDefault();var e=d(i).attr("data-page");e&&(r.tweenOut(r.reviewsList),r.getReviews(e,!0,!0))})}),0<this.deleteReviewButtons.length&&d(this.deleteReviewButtons).each(function(t,e){d(e).unbind("click"),d(e).click(function(t){if(t.preventDefault(),!confirm(r.options.lang.confirm_delete))return!1;d(r.formAnchor).hide(),r.tweenOut(r.reviewsList),r.tweenOut(r.rating),r.tweenOut(r.ratingAvg),d.ajax({type:"GET",async:!0,url:d(e).attr("href"),data:"format=raw&ts="+Date.now()}).done(function(t){d(r.reviewsList).trigger("djrv:reviewDeleted"),r.getReviews(r.current_page,!0,!1),r.getRating(!1),r.getRatingAvg(!1)})})}),0<this.addReviewButtons.length&&0<this.formAnchor.length&&d(this.addReviewButtons).each(function(t,e){d(e).unbind("click"),d(e).click(function(t){t.preventDefault(),d(r.formAnchor).hide(),r.loadEditForm(0,!0,!1)})}),0<this.closeReviewButtons.length&&0<this.formAnchor.length&&d(this.closeReviewButtons).each(function(t,e){d(e).unbind("click"),d(e).click(function(t){t.preventDefault(),d(r.formAnchor).hide(),0<r.reviewsList.length&&d("html, body").animate({scrollTop:d(r.reviewsList).offset().top},20)})}),d("#"+r.formAnchorId+" .djrv_modal-backdrop").unbind("click"),d("#"+r.formAnchorId+" .djrv_modal-backdrop").click(function(t){t.preventDefault(),d(r.formAnchor).hide(),0<r.reviewsList.length&&d("html, body").animate({scrollTop:d(r.reviewsList).offset().top},20)}),0<this.editReviewButtons.length&&0<this.formAnchor.length&&d(this.editReviewButtons).each(function(t,e){d(e).unbind("click"),d(e).click(function(t){t.preventDefault(),d(r.formAnchor).hide(),r.tweenOut(r.reviewsList),r.tweenOut(r.rating),r.tweenOut(r.ratingAvg),r.loadEditForm(d(e).attr("data-id"),!0,!1)})}),this.reviewForm.submit(function(t){t.preventDefault();var e=r.reviewForm.serialize();e+="&format=json&ts="+Date.now(),r.tweenOut(r.reviewsList),r.tweenOut(r.reviewForm),r.tweenOut(r.rating),r.tweenOut(r.ratingAvg),d.ajax({type:"POST",async:!1,url:r.url,data:e}).done(function(e){var i,n=!1;try{i=jQuery.parseJSON(e)}catch(t){i={status:0},n=!0,r.showAlert(e)}1!=i.status||n?n?(d(r.formAnchor).hide(),r.refreshAll(!1,!0)):(r.showAlert(i.error_message),r.tweenIn(r.reviewsList),r.tweenIn(r.reviewForm),r.tweenIn(r.rating),r.tweenIn(r.ratingAvg)):(""!=i.message&&r.showAlert(i.message),d(r.formAnchor).find("form").empty(),setTimeout(function(){d(r.formAnchor).hide(),d(r.formAnchor).trigger("djrv:reviewSaved"),r.refreshAll(!0,!0)},1500))}).fail(function(t,e,i){return 403!=t.status&&(401!=t.status&&(400!=t.status&&void 0))})}),0<this.reviewForm.length){var t=d('[data-wrapper="djrv-avg-'+this.options.item_id+'"]');0<t.length&&t.find(".djrv_star").unbind("click").click(function(t){t.preventDefault(),d(r.formAnchor).hide(),r.loadEditForm(0,!0,!1)}).css("cursor","pointer")}0<this.deleteCommentButtons.length&&d(this.deleteCommentButtons).each(function(t,e){d(e).unbind("click"),d(e).click(function(t){if(t.preventDefault(),!confirm(r.options.lang.confirm_delete))return!1;d(r.commentAnchor).hide(),r.tweenOut(r.reviewsList),r.tweenOut(r.rating),r.tweenOut(r.ratingAvg),d.ajax({type:"GET",async:!0,url:d(e).attr("href"),data:"format=raw&ts="+Date.now()}).done(function(t){r.getReviews(r.current_page,!0,!1),r.getRating(!1),r.getRatingAvg(!1)})})}),0<this.commentForm.length&&(0<this.addCommentButtons.length&&0<this.commentAnchor.length&&d(this.addCommentButtons).each(function(t,e){d(e).unbind("click"),d(e).click(function(t){t.preventDefault(),d(r.commentAnchor).hide(),r.loadCommentForm(0,d(e).attr("data-review_id"),!0,!1)})}),0<this.closeCommentButtons.length&&0<this.commentAnchor.length&&d(this.closeCommentButtons).each(function(t,e){d(e).unbind("click"),d(e).click(function(t){t.preventDefault(),d(r.commentAnchor).hide(),d("html, body").animate({scrollTop:d(r.reviewsList).offset().top},20)})}),0<this.editCommentButtons.length&&0<this.commentAnchor.length&&d(this.editCommentButtons).each(function(t,e){d(e).unbind("click"),d(e).click(function(t){t.preventDefault(),d(r.commentAnchor).hide(),r.tweenOut(r.reviewsList),r.tweenOut(r.rating),r.tweenOut(r.ratingAvg),r.loadCommentForm(d(e).attr("data-id"),d(e).attr("data-review_id"),!0,!1)})}),this.commentForm.submit(function(t){t.preventDefault();var e=r.commentForm.serialize();e+="&format=json&ts="+Date.now(),r.tweenOut(r.reviewsList),r.tweenOut(r.commentForm),r.tweenOut(r.rating),r.tweenOut(r.ratingAvg);var o=d("#djrv_comment_msg-"+r.options.item_id);d.ajax({type:"POST",async:!1,url:r.url,data:e}).done(function(e){var i,n=!1;try{i=jQuery.parseJSON(e)}catch(t){i={status:0},n=!0,r.showAlert(e,o)}1!=i.status||n?n?(d(r.commentAnchor).hide(),r.refreshAll(!1,!0)):(r.showAlert(i.error_message,o),r.tweenIn(r.reviewsList),r.tweenIn(r.commentForm),r.tweenIn(r.rating),r.tweenIn(r.ratingAvg)):(""!=i.message&&r.showAlert(i.message,o),d(r.commentAnchor).find("form").empty(),setTimeout(function(){d(r.commentAnchor).hide(),d(r.commentAnchor).trigger("djrv:commentSaved"),r.refreshAll(!0,!0)},1500))}).fail(function(t,e,i){return 403!=t.status&&(401!=t.status&&(400!=t.status&&void 0))})}))},loadEditForm:function(t,e,i,n){var o=this,r=o.options.captcha_key;r=r?"&captcha="+r:"";var s=void 0===n?"":"&"+n,a="option=com_djreviews&view=reviewform&format=raw&id="+parseInt(t)+r+s+"&ts="+Date.now();0==t&&(a+="&item_id="+o.options.item_id),d.ajax({type:"GET",async:i,url:o.url,data:a,dataType:"html"}).done(function(t){try{document.formvalidator=new JFormValidator}catch(t){}if(d(o.formAnchor).replaceWith(t),o.addToolTips(),o.attachControls(),r&&o.initRecaptcha(),typeof JFormValidator!=c)try{d(o.formAnchor).find("button.validate").click(function(t){if(t.stopPropagation(),document.formvalidator.isValid(d("#"+o.formId)))return!0;var e=d("#system-message-container");return 0<e.length?(d("#djrv_msg-"+o.options.item_id).html(e.html()),e.html(" ")):o.showAlert(o.options.lang.invalid_form),!1})}catch(t){}e&&(d(o.formAnchor).show(),d("#"+o.formAnchorId+" .djrv_modal-backdrop").addClass("in"),d("#"+o.formAnchorId+" .djrv_modal").addClass("in"),o.addToolTips(),d("html, body").animate({scrollTop:d(o.formAnchor).offset().top},200),o.tweenIn(o.reviewsList),o.tweenIn(o.rating),o.tweenIn(o.ratingAvg))}).fail(function(t,e,i){return 403!=t.status&&(401!=t.status&&(400!=t.status&&void 0))})},loadCommentForm:function(t,e,i,n){var o=this,r="option=com_djreviews&view=commentform&format=raw&id="+t+"&ts="+Date.now();0==t&&(r+="&review_id="+e+"&item_id="+o.options.item_id),d.ajax({type:"GET",async:n,url:o.url,data:r}).done(function(t){if(d(o.commentAnchor).replaceWith(t),o.addToolTips(),o.attachControls(),typeof JFormValidator!=c)try{document.formvalidator=new JFormValidator,d(o.commentAnchor).find("button.validate").click(function(t){if(t.stopPropagation(),document.formvalidator.isValid(d("#"+o.commentFormId)))return!0;var e=d("#system-message-container");return 0<e.length?(d("#djrv_comment_msg-"+o.options.item_id).html(e.html()),e.html(" ")):o.showAlert(o.options.lang.invalid_form,d("#djrv_comment_msg-"+o.options.item_id)),!1})}catch(t){}i&&(d(o.commentAnchor).show(),o.addToolTips(),o.tweenIn(o.reviewsList),o.tweenIn(o.rating),o.tweenIn(o.ratingAvg))}).fail(function(t,e,i){return 403!=t.status&&(401!=t.status&&(400!=t.status&&void 0))})},getReviews:function(t,e,i){var n=this;t!=c&&t||(t=0),n.current_page=t;var o="option=com_djreviews&view=reviewslist&format=raw&id="+n.options.item_id+"&limitstart="+t+"&ts="+Date.now();d.ajax({type:"GET",async:e,url:n.url,data:o}).done(function(t){d(n.reviewsList).replaceWith(t),n.addToolTips(),n.attachControls(),n.tweenIn(n.reviewsList),i&&d("html, body").animate({scrollTop:d(n.reviewsList).offset().top},20)}).fail(function(t,e,i){return 403!=t.status&&(401!=t.status&&(400!=t.status&&void 0))})},getRating:function(t){var e=this,i="option=com_djreviews&view=rating&format=raw&id="+e.options.item_id+"&ts="+Date.now();d.ajax({type:"GET",async:t,url:e.url,data:i}).done(function(t){d(e.rating).replaceWith(t),e.addToolTips(),e.tweenIn(e.rating)}).fail(function(t,e,i){return 403!=t.status&&(401!=t.status&&(400!=t.status&&void 0))})},getRatingAvg:function(t){var e=this;if(0!=e.ratingAvg.length){var i="option=com_djreviews&view=rating&layout=avg&format=raw&id="+e.options.item_id+"&ts="+Date.now();d.ajax({type:"GET",async:t,url:e.url,data:i}).done(function(t){d(e.ratingAvg).replaceWith(t),e.addToolTips(),e.tweenIn(e.ratingAvg)}).fail(function(t,e,i){return 403!=t.status&&(401!=t.status&&(400!=t.status&&void 0))})}},refreshAll:function(t,e){this.getRating(t),this.getRatingAvg(t),this.getReviews(0,t,e),this.loadEditForm(0,!1,!0),this.loadCommentForm(0,0,!1,!0)},tweenIn:function(t){0<d(t).length&&d(t).css({opacity:"1"})},tweenOut:function(t){0<d(t).length&&d(t).css({opacity:"0.3"})},addToolTips:function(){d(".djrv_tooltip").popover({html:!0,trigger:"hover focus",container:"body"})},showAlert:function(t,e){if(!e)e=d("#djrv_msg-"+this.options.item_id);var i='<div class="alert">'+t+"</div>";e.html(i)},initRecaptcha:function(){var t,e=document.getElementById("djrv_captcha-"+this.options.item_id);e&&""===e.innerHTML&&(t=e.dataset?e.dataset:{sitekey:e.getAttribute("data-sitekey"),theme:e.getAttribute("data-theme"),size:e.getAttribute("data-size")},grecaptcha.render(e,t))}},window.DJReviewsCore=t}(jQuery);